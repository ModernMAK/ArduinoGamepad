//#include <HID.h>

#include "DirtyValue.cpp"
#include <SoftwareSerial.h>

/*
 * 
 * pushbutton attached to pin 2 from +5V
 * 10K resistor attached to pin 2 from ground
*/


const int 
  A_BUTTON_PIN = 2,
  B_BUTTON_PIN = 3,
  X_BUTTON_PIN = 4,
  Y_BUTTON_PIN = 5,
  LCD_PIN = 6;
  
DirtyValue<bool>
  buttons[4];
int buttonPins[4] = {A_BUTTON_PIN,B_BUTTON_PIN,X_BUTTON_PIN,Y_BUTTON_PIN};
 
SoftwareSerial lcdScreen = SoftwareSerial(255,LCD_PIN);

void setup() {
  Serial.begin(9600);
  while(!Serial){
    ;
  }
  lcdScreen.begin(9600);

  for(int i = 0; i < 4; i ++){
    buttons[i] = {false};
    pinMode(buttonPins[i],INPUT);
  }
//  
//  pinMode(A_BUTTON_PIN,INPUT);
//  pinMode(B_BUTTON_PIN,INPUT);
//  pinMode(X_BUTTON_PIN,INPUT);
//  pinMode(Y_BUTTON_PIN,INPUT);
//  pinMode(LCD_PIN,OUTPUT);  
//  lcdScreen.write(17);
}

void loop() {
    updateState();
    serializeState();
//    updateLcd();
    delay(10);
}

void serialEvent(){
  if(Serial.available()){
    deserializeSerial();
  }
}
void updateState(){
  for(int i = 0; i < 4; i++){
    buttons[i].setValue(digitalRead(buttonPins[i]));  
  }
  /*
  aButton.setValue((digitalRead(A_BUTTON_PIN) == 0 ? false : true));
  bButton.setValue((digitalRead(B_BUTTON_PIN) == 0 ? false : true));  
  xButton.setValue((digitalRead(X_BUTTON_PIN) == 0 ? false : true));  
  yButton.setValue((digitalRead(Y_BUTTON_PIN) == 0 ? false : true));  
  */
}

void updateLcd(){
  /*
  if(aButton.getDirty() || bButton.getDirty() || xButton.getDirty() || yButton.getDirty()){

    lcdScreen.write(12);
    
    if(aButton.getValue()){
      lcdScreen.print("A");  
    }
    if(bButton.getValue()){
      lcdScreen.print("B");  
    }
    if(xButton.getValue()){
      lcdScreen.print("X");  
    }
    if(yButton.getValue()){
      lcdScreen.print("Y");  
    }
  }
  else{
  }
  */
}
const byte DESERIALIZE_CODE = 0;
void serializeState(){
  byte 
    dirtyBits,
    newBits,
    counter = 0;
  
  for(int i = 0; i < 4; i++){
    if(buttons[i].shouldSerialize()){
      bitSet(dirtyBits,i);        
      bitWrite(newBits,counter,buttons[i].getValue());
      counter++;
    }
  }

  if(counter > 0){
    Serial.write(DESERIALIZE_CODE);
    Serial.write(dirtyBits);
    Serial.write(newBits);
  }
}
void deserializeSerial(){
    byte actionCode = Serial.read
}
void deserializeState(){
  
}